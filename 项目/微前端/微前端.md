# å¾®å‰ç«¯
å¾®å‰ç«¯ï¼šä¸€ç§å°†ç‹¬ç«‹çš„å‰ç«¯åº”ç”¨ç»„æˆä¸€ä¸ªæ›´å¤§çš„æ•´ä½“çš„æ¶æ„é£æ ¼

åº”ç”¨ï¼š
- å…¼å®¹æ—§é¡¹ç›®
- åˆå¹¶å¤šé¡¹ç›®

ä¼˜ç‚¹ï¼š
- æŠ€æœ¯æ ˆæ— å…³
- é¡¹ç›®ç‹¬ç«‹ï¼šå¼€å‘éƒ¨ç½²æµ‹è¯•ç­‰
- å¯ç‹¬ç«‹è¿è¡Œï¼šæ¯ä¸ªå­åº”ç”¨ä¹‹é—´çŠ¶æ€éš”ç¦»ï¼Œè¿è¡Œæ—¶çŠ¶æ€ä¸å…±äº«

ç¼ºç‚¹ï¼š
- å¢åŠ ä¸‹è½½é‡ï¼šä¸åŒé¡¹ç›®çš„å…¬å…±ä¾èµ–åº“ä¸åŒ
- ä»£ç ç¯å¢ƒå·®å¼‚ï¼šæœ¬åœ°å¼€å‘å¯èƒ½éœ€è¦å…¶ä»–ä¾èµ–ç¯å¢ƒã€‚ä¾‹å¦‚aé¡¹å‰ç«¯ç›®å¯¹åº”aåç«¯é¡¹ç›®ï¼Œå¹¶ä¸”è¿˜éœ€è¦båç«¯é¡¹ç›®ç­‰æ›´å¤šç¯å¢ƒä¾èµ–
- å¤æ‚æ€§ï¼šéœ€è¦ç®¡ç†æ›´å¤šçš„ä»£ç åº“ã€æ›´å¤šçš„å·¥å…·ã€æ›´å¤šçš„æ„å»ºç®¡é“ã€æ›´å¤šçš„æœåŠ¡å™¨ã€æ›´å¤šçš„åŸŸåç­‰

å¤šæ ‡ç­¾é—®é¢˜ï¼š
- æµè§ˆå™¨å‰è¿›åé€€ï¼šåŒºåˆ†æ¿€æ´»é¡µé¢å’Œéæ¿€æ´»é¡µé¢
- ä¸åŒæ ‡ç­¾ä¹‹é—´çš„UIå¯èƒ½äº’ç›¸å¹²æ‰°ï¼Œä¾‹å¦‚ï¼šå¼¹çª—ã€‚è§£å†³shadow domç­‰éš”ç¦»

æ„æˆï¼š
- å…¬å…±å®¹å™¨
    - å…¬å…±ç»“æ„
    - å…¬å…±çš„çŠ¶æ€ç®¡ç†ã€‚ä¾‹å¦‚ç”¨æˆ·ä¿¡æ¯ã€å„ç§é…ç½®ä¿¡æ¯
    - é›†æˆå­åº”ç”¨
- å­åº”ç”¨ï¼šå…¬å…±å®¹å™¨åŒ…å«å¤šä¸ªå­åº”ç”¨ 

## 1. é›†æˆæ–¹å¼
- åç«¯æ¨¡æ¿é›†æˆï¼šä¸€ä¸ªå­åº”ç”¨ä¸€ä¸ªåŸŸåï¼ˆå¯ç”¨åå‘ä»£ç†è§£å†³ï¼‰
    - ç¼ºç‚¹ï¼šä¼šåˆ·æ–°é¡µé¢
- packageé›†æˆï¼šæ¯ä¸ªå¾®å‰ç«¯å‘å¸ƒä¸ºä¸€ä¸ª node åŒ…ï¼Œå®¹å™¨åº”ç”¨ç¨‹åºå°†æ‰€æœ‰å¾®å‰ç«¯åº”ç”¨ä½œä¸ºä¾èµ–é¡¹
    - å­åº”ç”¨å½¢å¼ï¼šnode åŒ…
    - ç¼ºç‚¹ï¼š
        - ä¾èµ–é¡ºåºé—®é¢˜
        - éœ€è¦æ‰“åŒ…è¿›ä¸»åŒ…ï¼Œå¯¼è‡´æ–‡ä»¶å¤§
- iframeé›†æˆ
    - å­åº”ç”¨å½¢å¼ï¼šiframeåµŒå¥—
    - ä¼˜ç‚¹
        - å®ç°ç®€å•
        - è‡ªç„¶ç¯å¢ƒéš”ç¦»
    - ç¼ºç‚¹ï¼š
        - èµ„æºé‡æ–°åŠ è½½
        - å ç”¨é¢å¤–çš„å†…å­˜
        - é˜»å¡ä¸»é¡µé¢çš„åŠ è½½
        - å¼¹çª—é—®é¢˜ï¼šå®¹å™¨éƒ¨åˆ†æ•ˆæœä¸å¥½
        - é¡µé¢è·³è½¬é—®é¢˜
        - å®¹å™¨å’Œå­åº”ç”¨é€šè®¯é—®é¢˜
- jsé›†æˆï¼šä¸€ä¸ªå­åº”ç”¨å¯¹åº”ä¸€ä¸ªscriptæ ‡ç­¾ï¼Œscriptä¸­æŠŠå­åº”ç”¨æŒ‚è½½åˆ°windowsä¸Šï¼Œéœ€è¦çš„æ—¶å€™è°ƒç”¨æ¸²æŸ“
    - å­åº”ç”¨å½¢å¼ï¼šç‹¬ç«‹çš„bundle
    - ä¼˜ç‚¹ï¼š
        - å•ç‹¬éƒ¨ç½²
        - çµæ´»æ€§ï¼šä½•æ—¶æ¸²æŸ“ã€ä¼ é€’å‚æ•°
    - ç¼ºç‚¹ï¼š
        - å…¨å±€å˜é‡
- web Componenté›†æˆï¼šjsé›†æˆçš„å˜å½¢ï¼Œæ¯ä¸ªå¾®åº”ç”¨å¯¹åº”ä¸€ä¸ª HTML è‡ªå®šä¹‰å…ƒç´ 
    - å­åº”ç”¨å½¢å¼ï¼šHTML è‡ªå®šä¹‰å…ƒç´ 
    - ä¼˜ç‚¹ï¼š
        - æ— å…¨å±€æ±¡æŸ“
        - å•ç‹¬éƒ¨ç½²
        - çµæ´»æ€§ï¼šä½•æ—¶æ¸²æŸ“ã€ä¼ é€’å‚æ•°
        
### 1.1 åç«¯æ¨¡æ¿é›†æˆ
```html
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Feed me</title>
  </head>
  <body>
    <h1>ğŸ½ Feed me</h1>
    <!--# include file="$PAGE.html" -->
  </body>
</html>
```
```text
server {
    listen 8080;
    server_name localhost;

    root /usr/share/nginx/html;
    index index.html;
    ssi on;

    # å°† / é‡å®šå‘åˆ° /browse
    rewrite ^/$ http://localhost:8080/browse redirect;

    # æ ¹æ®è·¯å¾„è®¿é—® html 
    location /browse {
      set $PAGE 'browse';
    }
    location /order {
      set $PAGE 'order';
    }
    location /profile {
      set $PAGE 'profile'
    }

    # æ‰€æœ‰å…¶ä»–è·¯å¾„éƒ½æ¸²æŸ“ /index.html
    error_page 404 /index.html;
}
```

### 1.2 packageé›†æˆ
```json
{
  "name": "@feed-me/container",
  "version": "1.0.0",
  "description": "A food delivery web app",
  "dependencies": {
    "@feed-me/browse-restaurants": "^1.2.3",
    "@feed-me/order-food": "^4.5.6",
    "@feed-me/user-profile": "^7.8.9"
  }
}
```
### 1.3 iframeé›†æˆ
```html
<html>
  <head>
    <title>Feed me!</title>
  </head>
  <body>
    <h1>Welcome to Feed me!</h1>

    <iframe id="micro-frontend-container"></iframe>

    <script type="text/javascript">
      const microFrontendsByRoute = {
        '/': 'https://browse.example.com/index.html',
        '/order-food': 'https://order.example.com/index.html',
        '/user-profile': 'https://profile.example.com/index.html',
      };

      const iframe = document.getElementById('micro-frontend-container');
      iframe.src = microFrontendsByRoute[window.location.pathname];
    </script>
  </body>
</html>
```

### 1.4 jsé›†æˆ
```html
<html>
  <head>
    <title>Feed me!</title>
  </head>
  <body>
    <h1>Welcome to Feed me!</h1>

    <!-- è¿™äº›è„šæœ¬ä¸ä¼šé©¬ä¸Šæ¸²æŸ“åº”ç”¨ -->
    <!-- è€Œæ˜¯åˆ†åˆ«æš´éœ²å…¨å±€å˜é‡ -->
    <script src="https://browse.example.com/bundle.js"></script>
    <script src="https://order.example.com/bundle.js"></script>
    <script src="https://profile.example.com/bundle.js"></script>

    <div id="micro-frontend-root"></div>

    <script type="text/javascript">
      // è¿™äº›å…¨å±€å‡½æ•°æ˜¯ä¸Šé¢è„šæœ¬æš´éœ²çš„
      const microFrontendsByRoute = {
        '/': window.renderBrowseRestaurants,
        '/order-food': window.renderOrderFood,
        '/user-profile': window.renderUserProfile,
      };
      const renderFunction = microFrontendsByRoute[window.location.pathname];

      // æ¸²æŸ“ç¬¬ä¸€ä¸ªå¾®åº”ç”¨
      renderFunction('micro-frontend-root');
    </script>
  </body>
</html>
```

### 1.5 Web Component é›†æˆ
```html
<html>
  <head>
    <title>Feed me!</title>
  </head>
  <body>
    <h1>Welcome to Feed me!</h1>

    <!-- è¿™äº›è„šæœ¬ä¸ä¼šé©¬ä¸Šæ¸²æŸ“åº”ç”¨ -->
    <!-- è€Œæ˜¯åˆ†åˆ«æä¾›è‡ªå®šä¹‰æ ‡ç­¾ -->
    <script src="https://browse.example.com/bundle.js"></script>
    <script src="https://order.example.com/bundle.js"></script>
    <script src="https://profile.example.com/bundle.js"></script>

    <div id="micro-frontend-root"></div>

    <script type="text/javascript">
      // è¿™äº›æ ‡ç­¾åæ˜¯ä¸Šé¢ä»£ç å®šä¹‰çš„
      const webComponentsByRoute = {
        '/': 'micro-frontend-browse-restaurants',
        '/order-food': 'micro-frontend-order-food',
        '/user-profile': 'micro-frontend-user-profile',
      };
      const webComponentType = webComponentsByRoute[window.location.pathname];

      // æ¸²æŸ“ç¬¬ä¸€ä¸ªå¾®åº”ç”¨ï¼ˆè‡ªå®šä¹‰æ ‡ç­¾ï¼‰
      const root = document.getElementById('micro-frontend-root');
      const webComponent = document.createElement(webComponentType);
      root.appendChild(webComponent);
    </script>
  </body>
</html>
```

## æ ·å¼
- æ ·å¼åçº¦å®š
- css module

## è·¨å¾®åº”ç”¨é€šä¿¡
åº”å‡å°‘é€šä¿¡ï¼Œå„ä¸ªåº”ç”¨æ˜¯ç‹¬ç«‹çš„

- postMessage
- å…¨å±€çŠ¶æ€ç®¡ç†ã€‚ä¾‹å¦‚Reduxã€å‘å¸ƒè®¢é˜…æ¨¡å¼ç­‰
- åœ°å€æ ä¼ å‚

## [ä¾‹å­](demo.microfrontends.com)
- å®¹å™¨ï¼š/
- å­åº”ç”¨é¤å…ï¼š/restaurant/:id
- å­åº”ç”¨å…³äºï¼š/about

1. å®¹å™¨é€šè¿‡è·¯ç”±æ¥æ¸²æŸ“æ¥æ¸²æŸ“å­åº”ç”¨ï¼ˆjsé›†æˆçš„æ–¹å¼ï¼‰
    - å®¹å™¨ç»´æŠ¤ä¸€ä¸ªå…¨å±€historyå¯¹è±¡ï¼ˆå­åº”ç”¨å…±ç”¨å®¹å™¨çš„historyï¼‰ï¼ŒåŒ¹é…å¯¹åº”çš„å­åº”ç”¨
    - è¯·æ±‚manifestæ–‡ä»¶ï¼Œè·å–å­åº”ç”¨çš„èµ„æºè·¯å¾„
    - æ„å»ºscriptæ ‡ç­¾ï¼Œè·å–å­åº”ç”¨èµ„æºæ–‡ä»¶
    - æ‰§è¡ŒæŒ‚è½½åœ¨windowsä¸Šçš„å­åº”ç”¨çš„æ–¹æ³•ï¼Œæ¸²æŸ“å­åº”ç”¨

```typescript jsx
class MicroFrontend extends React.Component {
  renderMicroFrontend = () => {
    const { name, history } = this.props;

    window[`render${name}`](`${name}-container`, history);
    // E.g.: window.renderBrowse('browse-container', history);
  };
  componentWillUnmount() {
    const { name } = this.props;

    window[`unmount${name}`](`${name}-container`);
  }
  componentDidMount() {
    const { name, host } = this.props;
    const scriptId = `micro-frontend-script-${name}`;

    if (document.getElementById(scriptId)) {
      this.renderMicroFrontend();
      return;
    }
    
    // è·å–manifestçš„åŸå› æ˜¯èµ„æºæ–‡ä»¶å¸¦æœ‰å“ˆå¸Œå€¼ä»¥æ–¹ä¾¿ç¼“å­˜
    fetch(`${host}/asset-manifest.json`)
      .then(res => res.json())
      .then(manifest => {
        const script = document.createElement('script');
        script.id = scriptId;
        script.src = `${host}${manifest['main.js']}`;
        script.onload = this.renderMicroFrontend;
        document.head.appendChild(script);
      });
  }
  render() {
    return <main id={`${this.props.name}-container`} />;
  }
}
<Switch>
  <Route exact path="/" component={Browse} />
  <Route exact path="/restaurant/:id" component={Restaurant} />
  <Route exact path="/random" render={Random} />
</Switch>
const Browse = ({ history }) => (
  <MicroFrontend history={history} name="Browse" host={browseHost} />
);
const Restaurant = ({ history }) => (
  <MicroFrontend history={history} name="Restaurant" host={restaurantHost} />
);
```

2. æ¸²æŸ“å­åº”ç”¨window.renderBrowse
```typescript jsx
// browse.js
import React from 'react';
import ReactDOM from 'react-dom';
import App from './App';
import registerServiceWorker from './registerServiceWorker';

window.renderBrowse = (containerId, history) => {
  ReactDOM.render(<App history={history} />, document.getElementById(containerId));
  registerServiceWorker();
};

window.unmountBrowse = containerId => {
  ReactDOM.unmountComponentAtNode(document.getElementById(containerId));
};
```

3. å…±äº«å†…å®¹ï¼šé€šè¿‡webpack.externalsæ¥å¤„ç†
```js
module.exports = (config, env) => {
  config.externals = {
    react: 'React',
    'react-dom': 'ReactDOM'
  }
  return config;
};
```
```html
<body>
  <div id="root"></div>
  <script src="%REACT_APP_CONTENT_HOST%/react.prod-16.8.6.min.js"></script>
  <script src="%REACT_APP_CONTENT_HOST%/react-dom.prod-16.8.6.min.js"></script>
</body>
```

## å‚è€ƒ
- [å¾®å‰ç«¯å…¥é—¨](https://juejin.im/post/5d8adb8ff265da5ba12cd173#heading-1)
- [å¾®å‰ç«¯çš„é‚£äº›äº‹å„¿](https://github.com/phodal/microfrontends#åŸºç¡€é“ºå«åº”ç”¨åˆ†å‘è·¯ç”±---è·¯ç”±åˆ†å‘åº”ç”¨)
